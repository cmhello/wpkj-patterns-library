# 方案A：顶部按钮 + 大模态视图（Gutenberg 编辑器）

## 目标体验
- 在编辑器顶部工具栏加入“Patterns”按钮，点击后弹出全屏或大模态视图。
- 模态内提供搜索、筛选、预览与插入，一次性完成发现→决策→插入的闭环。
- 性能优先：懒加载、分页、缓存与异步预热，避免阻塞编辑器。

## 信息架构
- 顶部按钮：常驻，单击打开/关闭模态。
- 模态主体：
  - 顶部：搜索框、筛选（分类、类型、免费/付费）。
  - 左侧：分类与类型过滤器（可折叠）。
  - 主区：模式卡片网格（标题、缩略图、标签、依赖状态）。
  - 右侧（可选）：预览与插入区（支持不同视口）。
  - 底部：分页/更多加载、性能提示与数据来源标注。

## 交互设计
- 打开模态：顶部按钮触发，支持 Esc/遮罩关闭。
- 搜索与筛选：输入即触发节流搜索，筛选支持多选与清空。
- 列表懒加载：首屏仅加载第一页，滚动或点击“加载更多”。
- 预览：卡片点击进入预览区，支持桌面/平板/移动切换。
- 插入：一键插入到当前选择位置；若有依赖缺失，提示并提供安装入口（后续迭代）。
- 收藏：卡片星标收藏，加入收藏列表（后续迭代）。

## 技术架构
- 编辑器扩展：`wp.editPost.PluginToolbarButton` + `wp.components.Modal`。
- 数据获取：使用设置页提供的 Manager API `apiBase`；JWT 通过设置注入到请求头。
- 性能策略：分页请求、去重缓存、后台同步预热（现有 Sync）。
- 兼容性：不依赖构建工具，使用原生 `wp.*` 包；后续可迁移至 `@wordpress/scripts`。

## UI 细节
- 按钮：图标 `layout`，标签“Patterns”；打开时高亮。
- 模态：宽度 90% 视口、最大高度 80vh；可切换全屏。
- 卡片：标题、类型徽标、分类标签；悬浮显示描述；点击进入预览。
- 空状态：无数据/搜索为空给出引导与重试。

## 配置与扩展
- 设置项：API 地址、JWT、最大注册数量、缓存 TTL。
- 本地化：通过 `wp_localize_script` 注入配置与文案。
- 扩展点：收藏、依赖安装、推荐算法、导入历史（后续迭代）。

## 错误处理与回退
- 网络错误：提示并支持重试；显示友好说明。
- 权限错误：JWT 校验失败时提示登录或配置。
- 兼容回退：无缩略图展示占位图；字段缺失安全降级。

## 无障碍支持
- 模态可聚焦，支持键盘导航与 Esc 退出。
- 按钮与控件提供 ARIA 标签与可见焦点。

## 测试与验证
- 单元：交互状态切换、搜索节流与分页逻辑。
- 手动：打开/关闭、加载数据、预览与插入路径。
- 性能：首屏加载时间、滚动加载与内存占用观察。

## 上线与运维
- 构建：当前直接加载 JS/CSS 文件，无打包依赖。
- 配置：在设置页填写 API 与 JWT，点击“Sync Now”预热缓存。
- 监控：建议后续引入日志与错误上报。

---

## 开发计划（迭代）

### Sprint 1（当前）
- 脚手架：注册编辑器脚本与样式，注入配置（API、JWT、文案）。
- 顶部按钮：实现打开/关闭模态的基础交互。
- 模态框：搭建骨架与占位内容，加载首屏数据（分类/模式第一页）。

### Sprint 2
- 列表与搜索：网格卡片渲染、搜索框节流与筛选控件。
- 分页加载：滚动/按钮加载更多，错误与空状态处理。
- 预览区：基础预览渲染与视口切换。

### Sprint 3
- 插入动作：内容插入到编辑器选区，兼容块上下文。
- 收藏：本地收藏存储与收藏列表视图。
- 依赖提示：检测缺失依赖并展示安装引导（仅提示）。

### Sprint 4（优化）
- 性能：结果缓存、请求合并与占位骨架屏。
- 无障碍：键盘导航完善与 ARIA 调整。
- 架构：可选迁移到 `@wordpress/scripts` 打包与国际化抽取。

### 验收标准
- 顶部按钮与模态稳定工作，首屏数据正常加载。
- 交互流畅，无明显阻塞编辑器；错误提示清晰。
- 与设置页/缓存同步逻辑兼容，无致命错误。

---

## 性能优化补充（注入逻辑）
- 注入方式从订阅 + 长轮询改为“一次性订阅 + MutationObserver（去抖）”。
- 移除约 10s 的轮询定时器；按钮挂载成功后短路停止所有监听。
- 初次渲染改为即刻尝试 + 观察者兜底，减少等待与无效尝试。
- 观察范围当前为 `document.body`；若仍有开销，可缩窄为 `#editor` 容器。

## 前端实现说明更新
- 固定唯一入口：左侧工具栏容器最前端；移除 Sidebar/MoreMenu/Toolbar 的 SlotFill 入口。
- 兼容渲染：优先使用 React 18 的 `createRoot`；旧版回退到 `wp.element.render`。
- 防重复挂载：已挂载后短路，避免重复 DOM 与渲染操作。

## 验收与监控（性能）
- 指标：编辑器首屏可交互时间（TTI）、交互延迟（INP）不显著增加。
- 采样：在空白页面与典型页面各测试 3 次，平均 TTI 差值 < 50ms；控制台无报错。
- 故障回退：观察者断开后仍可手动挂载；若容器变化，调整选择器实现适配。